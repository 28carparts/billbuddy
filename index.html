<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Buddy</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Swiper.js for sliders -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Active choice buttons */
        .choice-btn.active {
            background-color: #0ea5e9 !important; /* sky-500 */
            color: white !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Custom checkbox */
        .custom-checkbox {
            appearance: none; -webkit-appearance: none;
            height: 1.25rem; width: 1.25rem;
            border: 1px solid #94a3b8;
            border-radius: 0.25rem;
            display: inline-block; position: relative; cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .custom-checkbox:checked { background-color: #0ea5e9; border-color: #0ea5e9; }
        .custom-checkbox:checked::after {
            content: '✔'; font-size: 0.8rem; color: white;
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
        }
        .custom-checkbox:focus { outline: none; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5); }
        
        [contenteditable][data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8; /* slate-400 */
            pointer-events: none;
            display: block; 
        }

        /* Swiper container styles */
        .swiper-container {
            width: 100%;
            height: auto;
            overflow: hidden;
            padding: 4px 0;
        }
        .swiper-slide {
            width: auto; /* Let the content define the width */
            margin-right: 8px; /* Add some space between buttons */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-sky-100 min-h-screen flex flex-col pt-16 pb-20">

    <header class="text-center py-3 px-4 bg-gradient-to-r from-sky-500 to-indigo-600 shadow-lg fixed top-0 left-0 right-0 z-40 h-16 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <h1 class="text-xl md:text-2xl font-bold text-white drop-shadow-sm ml-4 shrink-0">💰 Bill Buddy</h1>
            <button id="trip-switcher-btn" class="hidden bg-white/20 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-white/30 transition-all duration-150 ease-in-out flex items-center justify-center gap-2 shrink-0 max-w-[150px] md:max-w-xs">
                <span id="current-trip-name" class="truncate text-sm"></span>
                <span class="text-xs">▼</span>
            </button>
        </div>
    </header>

    <!-- Auth Section -->
    <section id="page-auth" class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div id="login-container" class="bg-white rounded-xl shadow-xl p-6 sm:p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center text-slate-700">Welcome Back!</h2>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-semibold text-slate-600 mb-1.5">Email</label>
                            <input type="email" id="login-email" autocomplete="username" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-shadow" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-semibold text-slate-600 mb-1.5">Password</label>
                            <input type="password" id="login-password" autocomplete="current-password" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-shadow" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full mt-6 bg-sky-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-sky-600 active:bg-sky-700 transform hover:scale-105 active:scale-95 transition-all">Login</button>
                </form>
                <p class="text-center text-sm text-slate-500">
                    Don't have an account? <a href="#" id="show-register" class="font-semibold text-sky-600 hover:underline">Sign Up</a>
                </p>
            </div>

            <div id="register-container" class="bg-white rounded-xl shadow-xl p-6 sm:p-8 space-y-6 hidden">
                <h2 class="2xl font-bold text-center text-slate-700">Create Account</h2>
                <form id="register-form">
                     <div class="space-y-4">
                        <div>
                            <label for="register-email" class="block text-sm font-semibold text-slate-600 mb-1.5">Email</label>
                            <input type="email" id="register-email" autocomplete="username" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-shadow" required>
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-semibold text-slate-600 mb-1.5">Password</label>
                            <input type="password" id="register-password" autocomplete="new-password" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-shadow" required>
                        </div>
                         <div>
                            <label for="register-password-confirm" class="block text-sm font-semibold text-slate-600 mb-1.5">Confirm Password</label>
                            <input type="password" id="register-password-confirm" autocomplete="new-password" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-shadow" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full mt-6 bg-emerald-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-emerald-600 active:bg-emerald-700 transform hover:scale-105 active:scale-95 transition-all">Register</button>
                </form>
                <p class="text-center text-sm text-slate-500">
                    Already have an account? <a href="#" id="show-login" class="font-semibold text-sky-600 hover:underline">Log In</a>
                </p>
            </div>
        </div>
    </section>

    <!-- No Trips View -->
    <section id="page-no-trips" class="hidden flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-md text-center bg-white rounded-xl shadow-xl p-8 space-y-6">
            <h2 class="text-2xl font-bold text-slate-700">Welcome!</h2>
            <p class="text-slate-600">You're not part of any trips yet. Create a new one to get started!</p>
            <button id="create-first-trip-btn" class="w-full bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-600 active:bg-emerald-700 transform hover:scale-105 active:scale-95 transition-all">
                🚀 Create Your First Trip
            </button>
        </div>
    </section>

    <main id="app-content" class="flex-grow overflow-y-auto w-full hidden">
        <section id="page-buddies" class="page p-4 md:p-6">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-2xl mx-auto">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-700 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">👥</span>Manage Buddies
                </h2>
                <div class="space-y-4">
                    <div class="flex flex-row flex-nowrap gap-3 items-end">
                        <div class="flex-grow">
                            <label for="group-event-name" class="block text-sm font-semibold text-slate-600 mb-1.5">Trip Name</label>
                            <div class="relative">
                                <input type="text" id="group-event-name" class="w-full h-11 p-2.5 pr-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="e.g., Weekend Getaway 🎉" required>
                                <button id="clear-trip-name-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-slate-600 focus:outline-none" aria-label="Clear trip name">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="shrink-0">
                            <label for="trip-primary-currency" class="block text-sm font-semibold text-slate-600 mb-1.5">Currency</label>
                             <select id="trip-primary-currency" class="w-full h-11 p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow bg-white">
                                <option value="HKD">🇭🇰 HKD</option>
                                <option value="CNY">🇨🇳 CNY</option>
                                <option value="JPY">🇯🇵 JPY</option>
                                <option value="USD">🇺🇸 USD</option>
                                <option value="EUR">🇪🇺 EUR</option>
                                <option value="GBP">🇬🇧 GBP</option>
                                <option value="KRW">🇰🇷 KRW</option>
                            </select>
                        </div>
                    </div>
                    <div id="buddy-list" class="flex flex-col gap-3"></div>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="new-buddy" class="flex-grow p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="Enter buddy name">
                        <button id="add-buddy" class="bg-sky-500 text-white font-medium py-2.5 px-4 rounded-lg shadow hover:bg-sky-600 active:bg-sky-700 transform active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-1.5 shrink-0">
                            <span class="text-lg">✨</span>Add
                        </button>
                    </div>
                    <button id="done-buddies" class="w-full bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-600 active:bg-emerald-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2">
                        <span class="text-lg">✅</span>Done & Proceed
                    </button>
                </div>
            </div>
        </section>

        <section id="page-expense" class="page p-4 md:p-6 hidden">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-2xl mx-auto">
                <h2 id="expense-form-title" class="text-xl sm:text-2xl font-bold text-slate-700 flex items-center gap-2">
                     <span class="text-2xl sm:text-3xl">💸</span>Add New Expense
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Meal Type</label>
                        <div class="swiper-container" id="meal-swiper">
                            <div class="swiper-wrapper">
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Breakfast"><span class="text-lg">🥞</span>Breakfast</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Lunch"><span class="text-lg">🥪</span>Lunch</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Dinner"><span class="text-lg">🍝</span>Dinner</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Taxi"><span class="text-lg">🚕</span>Taxi</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Drink"><span class="text-lg">🍹</span>Drink</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Tea"><span class="text-lg">🍵</span>Tea</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Dessert"><span class="text-lg">🍰</span>Dessert</button></div>
                                <div class="swiper-slide"><button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-meal="Other"><span class="text-lg">🛍️</span>Other</button></div>
                            </div>
                        </div>
                        <input type="hidden" id="meal-type" name="meal-type">
                    </div>

                    <div>
                        <label for="restaurant" class="block text-sm font-semibold text-slate-600 mb-1.5">Place / Item Name</label>
                        <input type="text" id="restaurant" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="e.g., Cafe Delight or Movie Tickets" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Currency</label>
                        <div class="swiper-container" id="currency-swiper">
                            <div class="swiper-wrapper">
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="HKD"><span class="text-lg">🇭🇰</span>HKD</button></div>
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="CNY"><span class="text-lg">🇨🇳</span>CNY</button></div>
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="JPY"><span class="text-lg">🇯🇵</span>JPY</button></div>
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="USD"><span class="text-lg">🇺🇸</span>USD</button></div>
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="EUR"><span class="text-lg">🇪🇺</span>EUR</button></div>
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="GBP"><span class="text-lg">🇬🇧</span>GBP</button></div>
                                <div class="swiper-slide"><button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center w-full" data-currency="KRW"><span class="text-lg">🇰🇷</span>KRW</button></div>
                            </div>
                        </div>
                        <input type="hidden" id="currency" name="currency">
                    </div>

                    <div>
                        <label for="amount" class="block text-sm font-semibold text-slate-600 mb-1.5">Total Amount</label>
                        <input type="number" inputmode="decimal" id="amount" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="Enter amount" min="0" step="0.01" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Which buddies participated and who paid?</label>
                        <div class="flex justify-between items-center bg-slate-50 p-2.5 rounded-md mb-2">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" class="custom-checkbox" id="select-all-buddies">
                                <span class="text-sm text-slate-700 font-semibold">All</span>
                            </label>
                        </div>
                        <div id="combined-buddies-payer" class="space-y-2">
                        </div>
                    </div>

                    <button id="add-expense" class="w-full bg-sky-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-sky-600 active:bg-sky-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2">
                        <span class="text-lg">🎉</span>Add Expense
                    </button>
                </div>
            </div>
        </section>

        <section id="page-summary" class="page p-4 md:p-6 hidden">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-4xl mx-auto">
                 <h2 id="summary-title" class="text-xl sm:text-2xl font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">📊</span>Expense Summary
                </h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-slate-200">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Buddy</th>
                                <th id="summary-total-owed-header" class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Total Owed</th>
                                <th class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>

                <h2 class="text-xl sm:text-2xl font-bold text-slate-700 mt-6 mb-3 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">🧾</span>Meal Records
                </h2>
                <p id="total-spent" class="text-md font-semibold text-slate-700 mb-2"></p>
                <div id="meal-records" class="space-y-3"></div>
            </div>
        </section>

        <section id="page-debt" class="page p-4 md:p-6 hidden">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-4xl mx-auto">
                <h2 id="debt-title" class="text-xl sm:text-2xl font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">🤝</span>Debt Settlement
                </h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-slate-200">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Buddy</th>
                                <th id="debt-paid-header" class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Paid</th>
                                <th id="debt-owed-header" class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Owed</th>
                                <th id="debt-net-header" class="py-3 px-2 md:px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="debt-table" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>

                <!-- Individual Adjustments moved here -->
                <div class="mt-6 space-y-4">
                    <h3 class="text-xl sm:text-2xl font-bold text-slate-700 flex items-center gap-2">
                        <span class="text-2xl sm:text-3xl">💱</span>Individual Adjustments
                    </h3>
                    <div class="bg-slate-50 p-4 rounded-lg shadow-inner space-y-3">
                        <div>
                            <label for="adjustment-debtor" class="block text-sm font-semibold text-slate-600 mb-1.5">Who Pays?</label>
                            <select id="adjustment-debtor" class="w-full h-11 p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow">
                                <option value="">Select Payer</option>
                            </select>
                        </div>
                        <div>
                            <label for="adjustment-creditor" class="block text-sm font-semibold text-slate-600 mb-1.5">Who Receives?</label>
                            <select id="adjustment-creditor" class="w-full h-11 p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow">
                                <option value="">Select Receiver</option>
                            </select>
                        </div>
                        <div>
                            <label for="calculator-input" class="block text-sm font-semibold text-slate-600 mb-1.5">Calculator (optional, press 'Enter' to solve)</label>
                            <div class="relative">
                                <div id="calculator-input" contenteditable="true" data-placeholder="e.g., 8 + 28" class="w-full p-2.5 pr-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow bg-white"></div>
                                <button id="clear-calculator-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-slate-600 focus:outline-none" aria-label="Clear calculator input">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label for="adjustment-amount" class="block text-sm font-semibold text-slate-600 mb-1.5">Amount</label>
                            <div class="flex gap-2">
                                <select id="adjustment-currency" class="p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow bg-white shrink-0">
                                    <option value="HKD">🇭🇰 HKD</option>
                                    <option value="CNY">🇨🇳 CNY</option>
                                    <option value="JPY">🇯🇵 JPY</option>
                                    <option value="USD">🇺🇸 USD</option>
                                    <option value="EUR">🇪🇺 EUR</option>
                                    <option value="GBP">🇬🇧 GBP</option>
                                    <option value="KRW">🇰🇷 KRW</option>
                                </select>
                                <input type="number" inputmode="decimal" id="adjustment-amount" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="e.g., 50.00" min="0" step="0.01">
                            </div>
                        </div>
                        <button id="add-adjustment-btn" class="w-full bg-indigo-500 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-indigo-600 active:bg-indigo-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2">
                            <span class="text-lg">➕</span>Add Adjustment
                        </button>
                    </div>
                    <div id="current-adjustments" class="space-y-2">
                        <p class="text-slate-500 text-center py-2">No individual adjustments yet.</p>
                    </div>
                </div>

                <!-- Settlement Plan container remains here -->
                <div id="settlement-plan-container" class="mt-4">
                     <h3 class="text-md font-semibold text-slate-600 mb-2">Settlement Plan:</h3>
                     <div id="settlement-plan" class="text-sm space-y-1"></div>
                </div>

                <button id="copy-whatsapp" class="w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 active:bg-green-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2 mt-4">
                    <span class="text-lg">📱</span>Copy Data to WhatsApp
                </button>
                <button id="reset" class="w-full bg-rose-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-rose-600 active:bg-rose-700 transform active:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2 mt-4">
                    <span class="text-lg">♻️</span>Reset Trip Data
                </button>
            </div>
        </section>
    </main>

    <!-- Error/Success message container -->
    <div id="error-container" class="fixed top-40 left-1/2 -translate-x-1/2 transform z-[201] w-[90%] md:w-auto max-w-[90%] pointer-events-none">
         <p id="error" class="bg-red-100 text-red-700 border border-red-300 p-3 rounded-lg text-sm shadow-lg opacity-0 transition-opacity duration-300"></p>
    </div>
    
    <!-- Trip Switcher Modal -->
    <div id="trip-switcher-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[200] p-4 transition-opacity duration-300 opacity-0">
        <div id="trip-switcher-modal-content" class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full space-y-4 transform scale-95 transition-all duration-300">
            <h2 class="text-lg font-bold text-slate-800 flex justify-between items-center">
                <span>Your Trips</span>
                <button id="close-modal-icon-btn" class="text-slate-500 hover:text-slate-700 text-xl" aria-label="Close trip switcher modal">
                    <i class="fas fa-times"></i>
                </button>
            </h2>
            <div id="trip-list-menu" class="max-h-60 overflow-y-auto space-y-2"></div>
            <button id="create-new-trip-btn" class="w-full mt-2 bg-emerald-500 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-emerald-600 active:bg-emerald-700">
                Create New Trip
            </button>
            <button id="close-trip-switcher-btn" class="w-full mt-2 bg-slate-200 text-slate-700 font-medium py-2.5 px-6 rounded-lg hover:bg-slate-300">
                Cancel
            </button>
            <div id="logged-in-info" class="text-center text-sm text-slate-600 mt-4 py-2 border-t border-slate-200 pt-4 hidden">
                Logged in as: <span id="logged-in-email" class="font-semibold text-slate-800"></span> 
                <a href="#" id="logout-link" class="font-semibold text-sky-600 hover:underline ml-2">Logout</a>
            </div>
        </div>
    </div>

    <!-- Universal Modern Prompt Modal -->
    <div id="universal-prompt-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[200] p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-xl p-6 sm:p-8 space-y-6 w-full max-w-sm transform scale-95 transition-all duration-300">
            <h3 class="text-xl font-bold text-center text-slate-700 flex items-center justify-center gap-2" id="modal-prompt-title"></h3>
            <p class="text-slate-600 text-center text-sm" id="modal-prompt-message"></p>
            <div class="relative">
                <input type="text" id="modal-prompt-input" class="w-full p-2.5 pr-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 transition-shadow" placeholder="Enter name here" required>
                <button id="modal-clear-input-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-slate-600 focus:outline-none" aria-label="Clear input">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 font-medium transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Universal Confirmation Modal -->
    <div id="universal-confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[200] p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full space-y-4 transform scale-95 transition-all duration-300">
            <p class="text-lg font-semibold text-slate-800" id="confirmation-message"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmation-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 font-medium">Cancel</button>
                <button id="confirmation-confirm-btn" class="px-4 py-2 bg-rose-500 text-white rounded-md hover:bg-rose-600 font-medium">Confirm</button>
            </div>
        </div>
    </div>

    <nav id="app-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md shadow-[0_-4px_10px_rgba(0,0,0,0.05)] flex justify-around items-stretch h-20 z-40 border-t border-slate-200/80 hidden">
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-buddies">
            <span class="text-2xl">👥</span>
            <span class="text-xs mt-1">Buddies</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-expense">
            <span class="text-2xl">💸</span>
            <span class="text-xs mt-1">Expense</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-summary">
            <span class="text-2xl">📊</span>
            <span class="text-xs mt-1">Summary</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-debt">
            <span class="text-2xl">🤝</span>
            <span class="text-xs mt-1">Debt</span>
        </button>
    </nav>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Swiper.js for sliders -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC_fcgI07cxvP26LVW8W3ZqrWwTa3fmvLw",
          authDomain: "perrybillbuddy.firebaseapp.com",
          databaseURL: "https://perrybillbuddy-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "perrybillbuddy",
          storageBucket: "perrybillbuddy.appspot.com",
          messagingSenderId: "380690422701",
          appId: "1:380690422701:web:17da1bb5f55f12f3625f24"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let currentTripRef;
        let dataUnsubscribe;

        // --- App State ---
        let currentTripId = null;
        let appData = {
            owner: null,
            groupEventName: '',
            buddies: [],
            expenses: [],
            adjustments: [],
            primaryCurrency: 'HKD'
        };
        let editingExpenseIndex = -1;
        let isCalculatorResultShown = false;

        // --- Exchange Rate State ---
        const API_KEY = 'c86eace6da908459098e7518';
        const fallbackRates = { USD: 1, HKD: 7.8, CNY: 7.2, JPY: 157, EUR: 0.92, GBP: 0.79, KRW: 1380 };
        let exchangeRates = {};
        
        // --- DOM Elements ---
        const authPage = document.getElementById('page-auth');
        const noTripsPage = document.getElementById('page-no-trips');
        const appContent = document.getElementById('app-content');
        const appNav = document.getElementById('app-nav');
        const tripSwitcherBtn = document.getElementById('trip-switcher-btn');
        const currentTripNameEl = document.getElementById('current-trip-name');
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const mealButtons = document.querySelectorAll('.meal-btn');
        const currencyButtons = document.querySelectorAll('.currency-btn');
        const addExpenseBtn = document.getElementById('add-expense');
        const resetBtn = document.getElementById('reset');
        const copyWhatsappBtn = document.getElementById('copy-whatsapp');
        const addBuddyBtn = document.getElementById('add-buddy');
        const newBuddyInput = document.getElementById('new-buddy');
        const doneBuddiesBtn = document.getElementById('done-buddies');
        const groupEventNameInput = document.getElementById('group-event-name');
        const clearTripNameBtn = document.getElementById('clear-trip-name-btn');
        const tripPrimaryCurrencySelect = document.getElementById('trip-primary-currency');
        const expenseFormTitle = document.getElementById('expense-form-title');
        const errorMsgElement = document.getElementById('error');
        const navButtons = document.querySelectorAll('.nav-btn');
        const selectAllBuddiesCheckbox = document.getElementById('select-all-buddies');
        const adjustmentDebtorSelect = document.getElementById('adjustment-debtor');
        const adjustmentCreditorSelect = document.getElementById('adjustment-creditor');
        const tripSwitcherModal = document.getElementById('trip-switcher-modal');
        const loggedInInfoDiv = document.getElementById('logged-in-info');
        const loggedInEmailSpan = document.getElementById('logged-in-email');
        const logoutLink = document.getElementById('logout-link');
        const closeIconBtn = document.getElementById('close-modal-icon-btn');
        const calculatorInput = document.getElementById('calculator-input'); 
        const adjustmentAmountInput = document.getElementById('adjustment-amount');
        const clearCalculatorBtn = document.getElementById('clear-calculator-btn');

        // Modal Elements
        const universalPromptModal = document.getElementById('universal-prompt-modal');
        const modalPromptTitle = document.getElementById('modal-prompt-title');
        const modalPromptMessage = document.getElementById('modal-prompt-message');
        const modalPromptInput = document.getElementById('modal-prompt-input');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalClearInputBtn = document.getElementById('modal-clear-input-btn');
        const universalConfirmationModal = document.getElementById('universal-confirmation-modal');
        const confirmationMessageElement = document.getElementById('confirmation-message');
        const confirmationConfirmBtn = document.getElementById('confirmation-confirm-btn');
        const confirmationCancelBtn = document.getElementById('confirmation-cancel-btn');
        
        // --- Initialize Swipers ---
        function initSwipers() {
            new Swiper('#meal-swiper', {
                slidesPerView: 'auto',
                freeMode: true,
                mousewheel: true,
            });
            new Swiper('#currency-swiper', {
                slidesPerView: 'auto',
                freeMode: true,
                mousewheel: true,
            });
        }
        
        // --- Authentication Logic ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                authPage.classList.add('hidden');
                loggedInEmailSpan.textContent = user.email; 
                loggedInInfoDiv.classList.remove('hidden');
                
                const urlParams = new URLSearchParams(window.location.search);
                const sharedTripId = urlParams.get('shared');

                if (sharedTripId) {
                    await joinTrip(sharedTripId, user.uid, user.email);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                await loadUserDashboard(user.uid);
            } else {
                if (currentTripRef && dataUnsubscribe) {
                    currentTripRef.off('value', dataUnsubscribe); 
                }
                currentTripRef = null;
                dataUnsubscribe = null;
                currentTripId = null;
                
                authPage.classList.remove('hidden');
                appContent.classList.add('hidden');
                appNav.classList.add('hidden');
                noTripsPage.classList.add('hidden');
                tripSwitcherBtn.classList.add('hidden');
                loggedInInfoDiv.classList.add('hidden'); 
                
                appData = { owner: null, groupEventName: '', buddies: [], expenses: [], adjustments: [], primaryCurrency: 'HKD' };
                clearAllUI();
            }
        });
        
        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => showError(`Login Failed: ${error.message}`));
        });

        registerForm.addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-password-confirm').value;

            if (password !== confirmPassword) {
                showError("Passwords do not match.");
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .catch(error => showError(`Registration Failed: ${error.message}`));
        });
        
        logoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            closeTripSwitcherModal();
            auth.signOut();
        });

        document.getElementById('show-register').addEventListener('click', e => {
            e.preventDefault();
            loginContainer.classList.add('hidden');
            registerContainer.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', e => {
            e.preventDefault();
            registerContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
        });

        // --- Trip Management ---
        async function loadUserDashboard(userId) {
            const userTripsRef = database.ref(`users/${userId}/trips`);
            const snapshot = await userTripsRef.once('value');
            const userTripIds = snapshot.val();

            if (userTripIds) {
                const lastTripId = localStorage.getItem('lastActiveTripId');
                const tripToLoad = userTripIds[lastTripId] ? lastTripId : Object.keys(userTripIds)[0];
                await loadTrip(tripToLoad);
                appContent.classList.remove('hidden');
                appNav.classList.remove('hidden');
                noTripsPage.classList.add('hidden');
                tripSwitcherBtn.classList.remove('hidden');
            } else {
                appContent.classList.add('hidden');
                appNav.classList.add('hidden');
                noTripsPage.classList.remove('hidden');
                tripSwitcherBtn.classList.add('hidden');
            }
        }

        async function loadTrip(tripId) {
            if (currentTripRef && dataUnsubscribe) {
                currentTripRef.off('value', dataUnsubscribe);
            }
            currentTripId = tripId;
            localStorage.setItem('lastActiveTripId', tripId);
            currentTripRef = database.ref(`trips/${tripId}`);
            
            listenForDataChanges();
            showPage('page-buddies');
        }
        
        function listenForDataChanges() {
            if (currentTripRef) {
                dataUnsubscribe = currentTripRef.on('value', async (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return;

                    const oldCurrency = appData.primaryCurrency;
                    const newCurrency = data.primaryCurrency || 'HKD';

                    const shouldFetchRates = (oldCurrency !== newCurrency) || (Object.keys(exchangeRates).length === 0);

                    appData = {
                       owner: data.owner || null,
                       groupEventName: data.groupEventName || '',
                       buddies: data.buddies || [],
                       expenses: data.expenses || [],
                       adjustments: data.adjustments || [],
                       primaryCurrency: newCurrency
                    };
                    
                    if (shouldFetchRates) {
                        await fetchExchangeRates();
                    } else {
                        updateAllUI();
                    }
                }, error => {
                    console.error("Firebase data listener error:", error);
                    showError("Error loading trip data.");
                });
            }
        }
        
        async function joinTrip(tripId, userId, userEmail) {
            try {
                const tripRef = database.ref(`trips/${tripId}`);
                const tripSnapshot = await tripRef.once('value');
                if (!tripSnapshot.exists()) {
                    showError("This shared trip link is invalid or has been deleted.");
                    return;
                }
                const memberData = { email: userEmail };
                await database.ref(`trips/${tripId}/members`).update({ [userId]: memberData });
                await database.ref(`users/${userId}/trips/${tripId}`).set(true);
                showError("Successfully joined the trip!", 3000, 'success');
            } catch (error) {
                showError(`Error joining trip: ${error.message}`);
            }
        }
        
        async function createNewTrip() {
            const tripName = await showPromptModal("🚀 Trip Name", "What should we call your new adventure?", "", "My Awesome Trip");
            if (!tripName || !tripName.trim()) return;

            const currentUser = auth.currentUser;
            if (!currentUser) {
                showError("You must be logged in to create a trip.");
                return;
            }

            const newTripRef = database.ref('trips').push();
            const newTripId = newTripRef.key;

            const creatorName = currentUser.displayName || currentUser.email.split('@')[0] || 'Me';

            const initialTripData = {
                owner: currentUser.uid,
                members: { [currentUser.uid]: { email: currentUser.email } },
                groupEventName: tripName.trim(),
                buddies: [creatorName], 
                expenses: [],
                adjustments: [],
                primaryCurrency: 'HKD'
            };

            try {
                await newTripRef.set(initialTripData);
                await database.ref(`users/${currentUser.uid}/trips/${newTripId}`).set(true);
                
                await loadTrip(newTripId);
                
                appContent.classList.remove('hidden');
                appNav.classList.remove('hidden');
                noTripsPage.classList.add('hidden');
                tripSwitcherBtn.classList.remove('hidden');

                showError(`Trip '${tripName.trim()}' created successfully!`, 3000, 'success');

            } catch (error) {
                showError(`Failed to create trip: ${error.message}`);
            }
        }
        
        async function updateAndPopulateTripSwitcher() {
            const currentUser = auth.currentUser;
            if (!currentUser) return;

            const userTripsRef = database.ref(`users/${currentUser.uid}/trips`);
            const snapshot = await userTripsRef.once('value');
            const userTripIds = snapshot.val();
            
            const menu = document.getElementById('trip-list-menu');
            menu.innerHTML = '';

            if (!userTripIds) {
                menu.innerHTML = '<p class="text-center text-sm text-slate-500 py-2">No trips found.</p>';
                return;
            }
            
            const tripPromises = Object.keys(userTripIds).map(async (tripId) => {
                const tripDataSnapshot = await database.ref(`trips/${tripId}`).once('value');
                const tripData = tripDataSnapshot.val();
                if (!tripData) return null;
                return { 
                    id: tripId, 
                    name: tripData.groupEventName || 'Untitled Trip', 
                    owner: tripData.owner,
                    members: tripData.members || {}
                };
            });

            const trips = (await Promise.all(tripPromises)).filter(Boolean);

            trips.forEach(trip => {
                const isCurrentUserOwner = currentUser.uid === trip.owner;
                const ownedByLabel = isCurrentUserOwner ? ' (Owned)' : '';
                
                const itemContainer = document.createElement('div');
                itemContainer.className = 'trip-list-item-container bg-slate-50 rounded-lg';

                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2.5 cursor-pointer hover:bg-sky-100/80 rounded-t-lg ${trip.id === currentTripId ? 'bg-sky-100 font-bold text-sky-600' : ''}`;
                
                item.innerHTML = `
                    <span class="truncate pr-2">${trip.name}${ownedByLabel}</span>
                    <div class="flex items-center gap-3 shrink-0">
                        <button class="copy-trip-link-btn text-slate-500 hover:text-sky-500 transition-colors" data-trip-id="${trip.id}" aria-label="Copy link for ${trip.name}">
                            <i class="fas fa-clipboard text-base"></i>
                        </button>
                        <button class="toggle-members-btn text-slate-500 hover:text-sky-500 transition-colors" aria-label="Show members for ${trip.name}">
                            <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
                        </button>
                    </div>
                `;
                
                item.onclick = async (event) => {
                    if (!event.target.closest('button')) {
                        if (trip.id !== currentTripId) {
                            await loadTrip(trip.id);
                        }
                        closeTripSwitcherModal();
                    }
                };

                const membersPanel = document.createElement('div');
                membersPanel.className = 'members-panel hidden bg-slate-100/70 p-3 mx-0.5 mb-0.5 rounded-b-md text-xs text-slate-700 space-y-1';
                
                const memberEntries = Object.entries(trip.members);

                if (memberEntries.length > 0) {
                    memberEntries.forEach(([memberId, memberData]) => {
                        const email = memberData.email;
                        if (!email) return;

                        const emailDiv = document.createElement('div');
                        emailDiv.className = 'flex justify-between items-center p-1';

                        const isMemberOwner = memberId === trip.owner;
                        let emailContent;
                        if (isMemberOwner) {
                            emailContent = `<strong class="truncate font-bold">${email} (Owner)</strong>`;
                        } else {
                            emailContent = `<span class="truncate">${email}</span>`;
                        }
                        
                        let kickButton = '';
                        if (isCurrentUserOwner && !isMemberOwner) {
                            kickButton = `<button class="kick-member-btn text-rose-500 hover:text-rose-700 transition-colors ml-2" 
                                            data-trip-id="${trip.id}" 
                                            data-member-id="${memberId}" 
                                            data-member-email="${email}"
                                            aria-label="Remove ${email}">
                                        <i class="fas fa-user-slash text-sm"></i>
                                    </button>`;
                        }

                        emailDiv.innerHTML = `${emailContent}${kickButton}`;
                        membersPanel.appendChild(emailDiv);
                    });
                } else {
                    membersPanel.innerHTML = '<p class="text-slate-500 p-1">No members found.</p>';
                }
                
                itemContainer.appendChild(item);
                itemContainer.appendChild(membersPanel);
                menu.appendChild(itemContainer);
            });
        }

        // --- Event Delegation Setup ---
        function setupEventListeners() {
            // Main navigation
            appNav.addEventListener('click', (event) => {
                const navBtn = event.target.closest('.nav-btn');
                if (navBtn) {
                    showPage(navBtn.dataset.page);
                }
            });

            // Trip list in modal (event delegation)
            const tripListMenu = document.getElementById('trip-list-menu');
            if (tripListMenu) {
                tripListMenu.addEventListener('click', async (event) => {
                    const copyBtn = event.target.closest('.copy-trip-link-btn');
                    const toggleBtn = event.target.closest('.toggle-members-btn');
                    const kickBtn = event.target.closest('.kick-member-btn');

                    if (copyBtn) {
                        event.stopPropagation();
                        const tripId = copyBtn.dataset.tripId;
                        const shareLink = `${window.location.origin}${window.location.pathname}?shared=${tripId}`;
                        copyToClipboard(shareLink, "Trip invitation link copied! 🔗");
                    } else if (toggleBtn) {
                        event.stopPropagation();
                        const panel = toggleBtn.closest('.trip-list-item-container').querySelector('.members-panel');
                        const icon = toggleBtn.querySelector('i');
                        if (panel && icon) {
                            panel.classList.toggle('hidden');
                            icon.classList.toggle('rotate-180');
                        }
                    } else if (kickBtn) {
                        event.stopPropagation();
                        const { tripId, memberId, memberEmail } = kickBtn.dataset;
                        showConfirmation(`Are you sure you want to remove ${memberEmail}?`, () => {
                            removeMemberFromTrip(tripId, memberId, memberEmail);
                        });
                    }
                });
            }

            // Buddy list actions (event delegation)
            const buddyList = document.getElementById('buddy-list');
            if (buddyList) {
                buddyList.addEventListener('click', async (event) => {
                    const editBtn = event.target.closest('.edit-buddy');
                    const deleteBtn = event.target.closest('.delete-buddy');
                    if (editBtn) {
                        const index = parseInt(editBtn.dataset.index);
                        const currentName = appData.buddies[index];
                        const newName = await showPromptModal(`✏️ Edit Buddy`, `Rename buddy "${currentName}" to:`, currentName);
                        if (newName && newName.trim() && newName.trim() !== currentName) {
                            if (appData.buddies.includes(newName.trim())) { showError('Buddy name already exists.'); return; }
                            if (newName.trim().length > 50) { showError('Buddy name must be 50 characters or less.'); return; }
                            const oldName = appData.buddies[index];
                            appData.buddies[index] = newName.trim();
                            appData.expenses.forEach(exp => {
                                exp.buddies = exp.buddies.map(p => p === oldName ? newName.trim() : p);
                                if (exp.payer === oldName) exp.payer = newName.trim();
                            });
                            appData.adjustments.forEach(adj => {
                                if (adj.debtor === oldName) adj.debtor = newName.trim();
                                if (adj.creditor === oldName) adj.creditor = newName.trim();
                            });
                            saveDataToFirebase();
                            showError(`'${oldName}' renamed to '${newName.trim()}'`, 3000, 'success');
                        }
                    } else if (deleteBtn) {
                        const index = parseInt(deleteBtn.dataset.index);
                        const buddyToDelete = appData.buddies[index];
                        if (appData.expenses.some(exp => exp.buddies.includes(buddyToDelete) || exp.payer === buddyToDelete)) {
                            showError(`Cannot delete ${buddyToDelete}. They are part of existing expenses.`, 5000); return;
                        }
                        if (appData.adjustments.some(adj => adj.debtor === buddyToDelete || adj.creditor === buddyToDelete)) {
                            showError(`Cannot delete ${buddyToDelete}. They are involved in adjustments.`, 5000); return;
                        }
                        showConfirmation(`Are you sure you want to delete ${buddyToDelete}?`, () => {
                            appData.buddies.splice(index, 1);
                            saveDataToFirebase();
                            showError(`${buddyToDelete} has been deleted.`, 3000, 'success');
                        });
                    }
                });
            }

            // Meal records actions (event delegation)
            const mealRecords = document.getElementById('meal-records');
            if (mealRecords) {
                mealRecords.addEventListener('click', (event) => {
                    const editBtn = event.target.closest('.edit-meal-record');
                    const deleteBtn = event.target.closest('.delete-meal-record');

                    if (editBtn) {
                        const expenseId = Number(editBtn.dataset.id);
                        const indexToEdit = appData.expenses.findIndex(exp => exp.id === expenseId);
                        if (indexToEdit > -1) editExpense(indexToEdit);
                    } else if (deleteBtn) {
                         const expenseId = Number(deleteBtn.dataset.id);
                        const expenseToDelete = appData.expenses.find(exp => exp.id === expenseId);
                        if (expenseToDelete) {
                            const confirmationMessage = `Delete '${expenseToDelete.mealType} @ ${expenseToDelete.restaurant}'?`;
                            showConfirmation(confirmationMessage, () => {
                                appData.expenses = appData.expenses.filter(exp => exp.id !== expenseId);
                                saveDataToFirebase();
                                showError('Expense deleted!', 3000, 'success');
                            });
                        }
                    }
                });
            }

            // Other general event listeners
            document.getElementById('add-adjustment-btn').addEventListener('click', addAdjustment);
            document.getElementById('add-buddy').addEventListener('click', addBuddy);
            adjustmentDebtorSelect.addEventListener('change', filterCreditorDropdown);
            groupEventNameInput.addEventListener('change', () => {
                appData.groupEventName = groupEventNameInput.value.trim();
                saveDataToFirebase();
            });
            clearTripNameBtn.addEventListener('click', () => {
                if (groupEventNameInput.value) {
                    groupEventNameInput.value = '';
                    groupEventNameInput.dispatchEvent(new Event('change'));
                    groupEventNameInput.focus();
                }
            });
            tripPrimaryCurrencySelect.addEventListener('change', () => {
                currentTripRef.update({ primaryCurrency: tripPrimaryCurrencySelect.value });
            });
            doneBuddiesBtn.addEventListener('click', () => {
                if (!groupEventNameInput.value.trim()) { showError('Please enter a trip name.'); return; }
                if (appData.buddies.length === 0) { showError('Please add at least one buddy.'); return; }
                appData.groupEventName = groupEventNameInput.value.trim();
                saveDataToFirebase();
                showPage('page-expense');
            });
            addExpenseBtn.addEventListener('click', handleAddOrUpdateExpense);
            resetBtn.addEventListener('click', handleResetTrip);
            copyWhatsappBtn.addEventListener('click', () => copyToClipboard(generateWhatsAppMessage(), "Data copied!"));
            selectAllBuddiesCheckbox.addEventListener('change', handleSelectAllBuddies);
            tripSwitcherBtn.addEventListener('click', openTripSwitcherModal);
            document.getElementById('close-trip-switcher-btn').addEventListener('click', closeTripSwitcherModal);
            document.getElementById('create-new-trip-btn').addEventListener('click', () => { closeTripSwitcherModal(); createNewTrip(); });
            document.getElementById('create-first-trip-btn').addEventListener('click', createNewTrip);
            if (closeIconBtn) closeIconBtn.addEventListener('click', closeTripSwitcherModal);
            if(modalClearInputBtn) modalClearInputBtn.addEventListener('click', () => { if(modalPromptInput) { modalPromptInput.value = ''; modalPromptInput.focus(); } });

            // Calculator listeners
            if(calculatorInput) {
                calculatorInput.addEventListener('keydown', handleCalculatorKeydown);
                calculatorInput.addEventListener('input', () => { if (isCalculatorResultShown) { adjustmentAmountInput.value = ''; isCalculatorResultShown = false; }});
            }
            if(clearCalculatorBtn) clearCalculatorBtn.addEventListener('click', () => { calculatorInput.innerHTML = ''; adjustmentAmountInput.value = ''; isCalculatorResultShown = false; calculatorInput.focus(); });

            // Choice/Selection button listeners
            const mealTypeInput = document.getElementById('meal-type');
            document.getElementById('meal-swiper').addEventListener('click', (e) => handleChoiceButtonClick(e, '.meal-btn', mealButtons, mealTypeInput));
            const currencyInput = document.getElementById('currency');
            document.getElementById('currency-swiper').addEventListener('click', (e) => handleChoiceButtonClick(e, '.currency-btn', currencyButtons, currencyInput));
        }
        
        async function removeMemberFromTrip(tripId, memberIdToRemove, memberEmail) {
            try {
                await database.ref(`trips/${tripId}/members/${memberIdToRemove}`).remove();
                await database.ref(`users/${memberIdToRemove}/trips/${tripId}`).remove();
                showError(`${memberEmail} has been removed.`, 3000, 'success');
                updateAndPopulateTripSwitcher();
            } catch(error) {
                showError(`Failed to remove member: ${error.message}`);
            }
        }
        
        function openTripSwitcherModal() {
            updateAndPopulateTripSwitcher();
            tripSwitcherModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                tripSwitcherModal.classList.remove('opacity-0');
                tripSwitcherModal.querySelector('#trip-switcher-modal-content').classList.remove('scale-95');
            });
        }
        
        function closeTripSwitcherModal() {
            tripSwitcherModal.classList.add('opacity-0');
            tripSwitcherModal.querySelector('#trip-switcher-modal-content').classList.add('scale-95');
            setTimeout(() => tripSwitcherModal.classList.add('hidden'), 300);
        }

        // --- Database Logic ---
        function saveDataToFirebase() {
            if (!currentTripRef) {
                showError("No active trip reference to save data.");
                return;
            }
            const dataToUpdate = {
                groupEventName: appData.groupEventName,
                buddies: appData.buddies,
                expenses: appData.expenses,
                adjustments: appData.adjustments,
                primaryCurrency: appData.primaryCurrency
            };
            
            currentTripRef.update(dataToUpdate)
               .catch(err => {
                   console.error("Firebase update error:", err);
                   showError(`Failed to save data: ${err.message}`);
               });
        }

        // --- Main App Logic ---
        function updateAllUI() {
            if (!currentTripId) return;
            groupEventNameInput.value = appData.groupEventName;
            tripPrimaryCurrencySelect.value = appData.primaryCurrency;
            currentTripNameEl.textContent = appData.groupEventName || 'Untitled Trip';
            updateCurrencyDisplays();
            updateBuddyList();
            updateSummaryAndDebt();
            updateMealRecords();
            updateAdjustmentsDisplay();
            const isOwner = auth.currentUser && auth.currentUser.uid === appData.owner;
            resetBtn.style.display = isOwner ? 'flex' : 'none';
        }

        function updateCurrencyDisplays() {
            const currency = appData.primaryCurrency;
            document.getElementById('summary-title').innerHTML = `<span class="text-2xl sm:text-3xl">📊</span>Expense Summary (${currency})`;
            document.getElementById('debt-title').innerHTML = `<span class="text-2xl sm:text-3xl">🤝</span>Debt Settlement (${currency})`;
            document.getElementById('summary-total-owed-header').textContent = 'Total Owed';
            document.getElementById('debt-paid-header').textContent = 'Paid';
            document.getElementById('debt-owed-header').textContent = 'Owed';
            document.getElementById('debt-net-header').textContent = 'Net Balance';
            expenseFormTitle.innerHTML = `<span class="text-2xl sm:text-3xl">💸</span>Add New Expense`;
        }

        function getCurrencySymbol(currencyCode) {
            const symbols = { 'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥', 'HKD': '$', 'CNY': '¥', 'KRW': '₩' };
            return symbols[currencyCode] || currencyCode;
        }
        
        function clearAllUI() {
            document.getElementById('buddy-list').innerHTML = '';
            document.getElementById('summary-table').innerHTML = '';
            document.getElementById('meal-records').innerHTML = '';
            document.getElementById('debt-table').innerHTML = '';
            document.getElementById('settlement-plan').innerHTML = '';
            document.getElementById('current-adjustments').innerHTML = '';
        }

        async function fetchExchangeRates() {
            const baseCurrency = appData.primaryCurrency;
            try {
                const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/${baseCurrency}`);
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const data = await response.json();
                if (data.result === 'success' && data.conversion_rates) {
                    exchangeRates = data.conversion_rates;
                } else {
                     throw new Error(data['error-type'] || 'API request was not successful');
                }
            } catch (error) {
                console.error('Failed to fetch exchange rates:', error);
                showError(`API Error: ${error.message}. Using fallback rates.`, 5000);
                exchangeRates = {};
                const primaryInUsd = fallbackRates[baseCurrency];
                for (const key in fallbackRates) {
                    exchangeRates[key] = fallbackRates[key] / primaryInUsd;
                }
            }
            updateAllUI();
        }

        function formatTimestamp(dateString) {
            const date = new Date(dateString);
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            return date.toLocaleString('en-US', options);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.remove('hidden');

            navButtons.forEach(btn => {
                const isActive = btn.dataset.page === pageId;
                btn.classList.toggle('text-sky-600', isActive);
                btn.classList.toggle('font-semibold', isActive);
                btn.classList.toggle('bg-sky-100', isActive);
                btn.classList.toggle('rounded-lg', isActive);
                btn.classList.toggle('text-slate-600', !isActive);
                if (!isActive) btn.classList.remove('bg-sky-100', 'rounded-lg');
            });
             window.scrollTo(0, 0);
        }

        function handleChoiceButtonClick(event, buttonSelector, buttonNodeList, hiddenInput) {
            const button = event.target.closest(buttonSelector);
            if (!button) return;
            buttonNodeList.forEach(b => b.classList.remove('active'));
            button.classList.add('active');
            hiddenInput.value = button.dataset.meal || button.dataset.currency;
        }

        function updateBuddyList() {
            const buddyList = document.getElementById('buddy-list');
            const combinedBuddiesPayerContainer = document.getElementById('combined-buddies-payer');
            if(!buddyList || !combinedBuddiesPayerContainer) return;

            buddyList.innerHTML = '';
            combinedBuddiesPayerContainer.innerHTML = '';

            appData.buddies.forEach((buddy, index) => {
                const buddyId = `buddy_${index}_${buddy.replace(/\s+/g, '_')}`;
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center justify-between bg-slate-50 p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow';
                listItem.innerHTML = `
                    <span class="text-slate-800 font-medium text-sm sm:text-base">${buddy}</span>
                    <div class="flex gap-2">
                        <button class="edit-buddy bg-amber-400 text-white p-0 rounded-md hover:bg-amber-500 transition-colors text-lg flex items-center justify-center w-9 h-9" data-index="${index}" aria-label="Edit ${buddy}">✏️</button>
                        <button class="delete-buddy bg-rose-500 text-white p-0 rounded-md hover:bg-rose-600 transition-colors text-lg flex items-center justify-center w-9 h-9" data-index="${index}" aria-label="Delete ${buddy}">🗑️</button>
                    </div>`;
                buddyList.appendChild(listItem);

                const combinedItem = document.createElement('div');
                combinedItem.className = 'flex justify-between items-center bg-slate-50 p-2.5 rounded-md';
                combinedItem.innerHTML = `
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" class="buddy custom-checkbox" value="${buddy}" id="exp_buddy_${buddyId}">
                        <span class="text-sm text-slate-700">${buddy}</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="radio" name="payer" class="payer custom-checkbox" value="${buddy}" id="payer_${buddyId}">
                        <span class="text-sm text-slate-700">Paid</span>
                    </label>`;
                combinedBuddiesPayerContainer.appendChild(combinedItem);
            });
        }
        
        function handleSelectAllBuddies() {
            document.querySelectorAll('#combined-buddies-payer .buddy').forEach(cb => cb.checked = selectAllBuddiesCheckbox.checked);
        }

        function addBuddy() {
            const newName = newBuddyInput.value.trim();
            if (!newName) { showError('Please enter a buddy name.'); return; }
            if (appData.buddies.includes(newName)) { showError('Buddy already exists.'); return; }
            if (newName.length > 50) { showError('Buddy name must be 50 characters or less.'); return; }
            appData.buddies.push(newName);
            saveDataToFirebase();
            newBuddyInput.value = '';
            showError(`${newName} added! ✨`, 3000, 'success');
        }
        
        function handleAddOrUpdateExpense() {
            if (!appData.groupEventName) { showError('Please set a trip name on the Buddies tab first.'); showPage('page-buddies'); return; }
            const mealType = document.getElementById('meal-type').value;
            const restaurant = document.getElementById('restaurant').value.trim();
            const currency = document.getElementById('currency').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const selectedBuddies = Array.from(document.querySelectorAll('#combined-buddies-payer .buddy:checked')).map(cb => cb.value);
            const payerRadio = document.querySelector('#combined-buddies-payer .payer:checked');
            if (!mealType) { showError('Please select a meal type.'); return; }
            if (!restaurant) { showError('Please enter a place or item name.'); return; }
            if (!currency) { showError('Please select a currency.'); return; }
            if (isNaN(amount) || amount <= 0) { showError('Please enter a valid amount.'); return; }
            if (selectedBuddies.length === 0) { showError('Please select at least one buddy.'); return; }
            if (!payerRadio) { showError('Please select who paid.'); return; }
            if (!selectedBuddies.includes(payerRadio.value)) { showError('The payer must be one of the selected buddies.'); return; }

            const amountInPrimaryCurrency = amount / (exchangeRates[currency] || 1);
            const newExpense = {
                id: editingExpenseIndex > -1 ? appData.expenses[editingExpenseIndex].id : Date.now(),
                mealType, restaurant, currency, amount, amountInPrimaryCurrency,
                buddies: selectedBuddies,
                perBuddy: amountInPrimaryCurrency / selectedBuddies.length,
                payer: payerRadio.value,
                timestamp: new Date().toISOString()
            };

            if (editingExpenseIndex > -1) {
                appData.expenses[editingExpenseIndex] = newExpense;
                showError('Expense updated! ✨', 3000, 'success');
            } else {
                appData.expenses.push(newExpense);
                showError('Expense added! 🎉', 3000, 'success');
            }
            editingExpenseIndex = -1;
            addExpenseBtn.innerHTML = '<span class="text-lg">🎉</span>Add Expense';
            addExpenseBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600', 'active:bg-amber-700');
            addExpenseBtn.classList.add('bg-sky-500', 'hover:bg-sky-600', 'active:bg-sky-700');
            
            saveDataToFirebase();
            clearForm();
            showPage('page-summary');
        }

        function handleResetTrip() {
            showConfirmation('Reset all expenses and adjustments for this trip?', async () => {
                appData.expenses = [];
                appData.adjustments = [];
                appData.primaryCurrency = 'HKD';
                await fetchExchangeRates();
                saveDataToFirebase();
                showError('Trip data has been reset. 🚀', 3000, 'success');
                showPage('page-buddies');
            });
        }
        
        // --- Calculation and Rendering ---
        function calculateBalances() {
            const balances = {};
            appData.buddies.forEach(buddy => {
                balances[buddy] = { paid: 0, owed: 0, net: 0 };
            });

            appData.expenses.forEach(exp => {
                if (balances[exp.payer]) balances[exp.payer].paid += exp.amountInPrimaryCurrency;
                exp.buddies.forEach(buddy => {
                    if (balances[buddy]) balances[buddy].owed += exp.perBuddy;
                });
            });

            appData.adjustments.forEach(adj => {
                const amountInPrimary = adj.amount / (exchangeRates[adj.originalCurrency] || 1);
                if (balances[adj.debtor]) balances[adj.debtor].net -= amountInPrimary;
                if (balances[adj.creditor]) balances[adj.creditor].net += amountInPrimary;
            });

            appData.buddies.forEach(buddy => {
                balances[buddy].net = (balances[buddy].paid - balances[buddy].owed) + balances[buddy].net;
            });
            return balances;
        }
        
        function updateSummaryAndDebt() {
            const summaryTableBody = document.getElementById('summary-table');
            const debtTableBody = document.getElementById('debt-table');
            const settlementPlanDiv = document.getElementById('settlement-plan');
            if (!summaryTableBody || !debtTableBody || !settlementPlanDiv) return;

            summaryTableBody.innerHTML = '';
            debtTableBody.innerHTML = '';
            settlementPlanDiv.innerHTML = '';

            const balances = calculateBalances();
            const currencySymbol = getCurrencySymbol(appData.primaryCurrency);
            const buddyDetails = {};
            appData.buddies.forEach(buddy => buddyDetails[buddy] = []);
            appData.expenses.forEach(exp => {
                exp.buddies.forEach(buddy => {
                    buddyDetails[buddy].push(`<div class="text-xs"><span class="font-medium">${exp.mealType}</span> at ${exp.restaurant}: ${currencySymbol}${exp.perBuddy.toFixed(2)}</div>`);
                });
            });

            if (appData.buddies.length === 0) {
                const noDataRow = (cols) => `<tr><td colspan="${cols}" class="py-4 px-4 text-center text-slate-500">No data yet.</td></tr>`;
                summaryTableBody.innerHTML = noDataRow(3);
                debtTableBody.innerHTML = noDataRow(4);
                settlementPlanDiv.innerHTML = '<p class="text-slate-500 text-center py-2">Add buddies and expenses.</p>';
                return;
            }

            appData.buddies.forEach(buddy => {
                // Summary Row
                const summaryRow = summaryTableBody.insertRow();
                summaryRow.innerHTML = `
                    <td class="py-3 px-2 md:px-4 text-slate-700 font-medium whitespace-normal">${buddy}</td>
                    <td class="py-3 px-2 md:px-4 text-slate-700 whitespace-nowrap">${currencySymbol}${balances[buddy].owed.toFixed(2)}</td>
                    <td class="py-3 px-2 md:px-4 text-slate-700 space-y-1 whitespace-normal">${buddyDetails[buddy].join('') || '<span class="text-slate-400">No expenses</span>'}</td>
                `;
                // Debt Row
                const net = balances[buddy].net;
                const colorClass = net < -0.005 ? 'text-red-600 font-semibold' : net > 0.005 ? 'text-green-600 font-semibold' : 'text-slate-700';
                const debtRow = debtTableBody.insertRow();
                debtRow.innerHTML = `
                    <td class="py-3 px-2 md:px-4 text-slate-700 font-medium whitespace-normal">${buddy}</td>
                    <td class="py-3 px-2 md:px-4 text-slate-700 whitespace-nowrap">${currencySymbol}${balances[buddy].paid.toFixed(2)}</td>
                    <td class="py-3 px-2 md:px-4 text-slate-700 whitespace-nowrap">${currencySymbol}${balances[buddy].owed.toFixed(2)}</td>
                    <td class="py-3 px-2 md:px-4 whitespace-nowrap ${colorClass}">${currencySymbol}${net.toFixed(2)}</td>
                `;
            });
            
            // Settlement Plan
            const debtors = appData.buddies.filter(p => balances[p].net < -0.005).map(p => ({ name: p, amount: -balances[p].net }));
            const creditors = appData.buddies.filter(p => balances[p].net > 0.005).map(p => ({ name: p, amount: balances[p].net }));
            const settlements = [];
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const amount = Math.min(debtors[i].amount, creditors[j].amount);
                if (amount > 0.005) {
                    settlements.push(`<span class="font-medium text-rose-600">${debtors[i].name}</span> pays <span class="font-medium text-emerald-600">${creditors[j].name}</span> <strong class="text-sky-700">${amount.toFixed(2)} ${appData.primaryCurrency}</strong>`);
                    debtors[i].amount -= amount;
                    creditors[j].amount -= amount;
                }
                if (debtors[i].amount < 0.005) i++;
                if (creditors[j].amount < 0.005) j++;
            }

            if (settlements.length === 0) {
                settlementPlanDiv.innerHTML = '<p class="text-green-600 font-medium text-center py-2">🎉 All debts are settled!</p>';
            } else {
                settlementPlanDiv.innerHTML = `<ul class="space-y-2">${settlements.map(s => `<li class="bg-sky-50 p-2.5 rounded-md text-sm shadow-sm border border-sky-100">${s}</li>`).join('')}</ul>`;
            }
        }
        
        function updateMealRecords() {
            const totalSpentElement = document.getElementById('total-spent');
            const mealRecordsContainer = document.getElementById('meal-records');
            if(!totalSpentElement || !mealRecordsContainer) return;

            const total = appData.expenses.reduce((sum, exp) => sum + exp.amountInPrimaryCurrency, 0);
            totalSpentElement.textContent = `Total Spent: ${appData.primaryCurrency} ${total.toFixed(2)} | ${appData.expenses.length} transaction${appData.expenses.length !== 1 ? 's' : ''}`;

            if (appData.expenses.length === 0) {
                mealRecordsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No meal records yet. 🍽️</p>';
                return;
            }
            const sortedExpenses = [...appData.expenses].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            mealRecordsContainer.innerHTML = sortedExpenses.map(exp => `
                <div class="relative bg-white p-3.5 rounded-lg shadow-sm border border-slate-200 text-xs text-slate-600 leading-relaxed hover:shadow-md transition-shadow">
                    <div class="absolute top-2 right-2 flex gap-1">
                        <button class="edit-meal-record bg-sky-100 text-sky-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold hover:bg-sky-200" data-id="${exp.id}" aria-label="Edit meal record">✏️</button>
                        <button class="delete-meal-record bg-rose-100 text-rose-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold hover:bg-rose-200" data-id="${exp.id}" aria-label="Delete meal record">✖</button>
                    </div>
                    <div class="flex justify-between items-start mb-1 pr-14">
                        <span class="font-semibold text-slate-800 text-sm">${exp.mealType} @ ${exp.restaurant}</span>
                        <span class="text-sky-600 font-bold text-sm">${exp.currency} ${exp.amount.toFixed(2)}</span>
                    </div>
                    <div class="text-xs">Paid by: <strong class="text-slate-700">${exp.payer}</strong></div>
                    <div class="text-xs">Shared with: <em class="text-slate-500">${exp.buddies.join(', ')}</em></div>
                    <div class="text-right text-slate-400 text-[10px] mt-1.5">${formatTimestamp(exp.timestamp)}</div>
                </div>`
            ).join('');
        }
        
        function editExpense(index) {
            const expense = appData.expenses[index];
            if (!expense) return;
            editingExpenseIndex = index;

            document.getElementById('meal-type').value = expense.mealType;
            mealButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.meal === expense.mealType));
            document.getElementById('restaurant').value = expense.restaurant;
            document.getElementById('currency').value = expense.currency;
            currencyButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.currency === expense.currency));
            document.getElementById('amount').value = expense.amount;
            
            document.querySelectorAll('#combined-buddies-payer .buddy').forEach(cb => cb.checked = false);
            document.querySelectorAll('#combined-buddies-payer .payer').forEach(radio => radio.checked = false);
            selectAllBuddiesCheckbox.checked = false;

            expense.buddies.forEach(p => {
                const checkbox = document.querySelector(`#combined-buddies-payer .buddy[value="${p}"]`);
                if (checkbox) checkbox.checked = true;
            });
            const payerRadio = document.querySelector(`#combined-buddies-payer .payer[value="${expense.payer}"]`);
            if (payerRadio) payerRadio.checked = true;

            addExpenseBtn.innerHTML = '💾 Update Expense';
            addExpenseBtn.classList.remove('bg-sky-500', 'hover:bg-sky-600', 'active:bg-sky-700');
            addExpenseBtn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'active:bg-amber-700');

            showPage('page-expense');
            window.scrollTo(0, 0);
        }
        
        function updateAdjustmentsDisplay() {
            const container = document.getElementById('current-adjustments');
            if (!container || !adjustmentDebtorSelect || !adjustmentCreditorSelect) return;

            adjustmentDebtorSelect.innerHTML = '<option value="">Select Payer</option>';
            adjustmentCreditorSelect.innerHTML = '<option value="">Select Receiver</option>';
            appData.buddies.forEach(p => {
                adjustmentDebtorSelect.add(new Option(p, p));
                adjustmentCreditorSelect.add(new Option(p, p));
            });
            filterCreditorDropdown();

            if (appData.adjustments.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-2">No individual adjustments yet.</p>';
                return;
            }

            container.innerHTML = appData.adjustments.map((adj, index) => {
                const amountInPrimary = adj.amount / (exchangeRates[adj.originalCurrency] || 1);
                const displayAmount = `<strong class="text-sky-700">${adj.originalCurrency} ${adj.amount.toFixed(2)}</strong> 
                                     <span class="text-slate-500 text-xs">(~${amountInPrimary.toFixed(2)} ${appData.primaryCurrency})</span>`;
                return `
                <div class="relative bg-white p-3.5 rounded-lg shadow-sm border border-slate-200 text-sm flex justify-between items-center">
                    <span class="flex-grow flex flex-wrap items-center gap-x-2">
                        <strong class="text-rose-600">${adj.debtor}</strong> pays <strong class="text-emerald-600">${adj.creditor}</strong> ${displayAmount}
                    </span>
                    <button class="delete-adjustment-btn bg-rose-100 text-rose-600 rounded-full w-6 h-6 flex items-center justify-center font-bold hover:bg-rose-200 shrink-0 ml-2" data-index="${index}">✖</button>
                </div>`;
            }).join('');

            container.querySelectorAll('.delete-adjustment-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    showConfirmation(`Remove this adjustment?`, () => {
                        appData.adjustments.splice(index, 1);
                        saveDataToFirebase();
                        showError('Adjustment removed.', 3000, 'success');
                    });
                });
            });
        }
        
        function addAdjustment() {
            const debtor = adjustmentDebtorSelect.value;
            const creditor = adjustmentCreditorSelect.value;
            const currency = document.getElementById('adjustment-currency').value;
            const amount = parseFloat(adjustmentAmountInput.value);

            if (!debtor || !creditor || !currency || isNaN(amount) || amount <= 0) { showError('Please fill all adjustment fields.'); return; }
            if (debtor === creditor) { showError('Payer and Receiver cannot be the same.'); return; }
            
            appData.adjustments.push({ debtor, creditor, amount, originalCurrency: currency });
            saveDataToFirebase();
            
            adjustmentAmountInput.value = '';
            calculatorInput.innerHTML = '';
            isCalculatorResultShown = false;
            adjustmentDebtorSelect.value = '';
            adjustmentCreditorSelect.value = '';
            filterCreditorDropdown();
            showError('Adjustment added!', 3000, 'success');
        }
        
        function filterCreditorDropdown() {
            const selectedDebtor = adjustmentDebtorSelect.value;
            Array.from(adjustmentCreditorSelect.options).forEach(opt => {
                opt.style.display = (opt.value === selectedDebtor && selectedDebtor !== "") ? 'none' : '';
            });
            if (adjustmentCreditorSelect.value === selectedDebtor) adjustmentCreditorSelect.value = "";
        }

        function generateWhatsAppMessage() {
            let message = `*💰 ${appData.groupEventName || 'Group Event'} Recap* \n\n`;
            const primaryCurrency = appData.primaryCurrency;
            const balances = calculateBalances();

            message += `*📊 Net Balance Summary (${primaryCurrency})*\n`;
            appData.buddies.forEach(buddy => {
                const net = balances[buddy].net;
                if (net < -0.005) message += `• *${buddy}* pays ${primaryCurrency} ${(-net).toFixed(2)}\n`;
                else if (net > 0.005) message += `• *${buddy}* receives ${primaryCurrency} ${net.toFixed(2)}\n`;
            });
            message += `\n`;

            message += `*🧾 Transaction Records*\n`;
            if (appData.expenses.length > 0) {
                appData.expenses.forEach(exp => {
                    message += `• ${exp.mealType} @ ${exp.restaurant}: *${exp.currency} ${exp.amount.toFixed(2)}* (Paid by ${exp.payer})\n`;
                });
            } else {
                message += `_No records yet._\n`;
            }
            message += `\n`;

            if (appData.adjustments.length > 0) {
                message += `*💱 Individual Adjustments*\n`;
                appData.adjustments.forEach(adj => {
                    message += `• *${adj.debtor}* pays *${adj.creditor}* *${adj.originalCurrency} ${adj.amount.toFixed(2)}*\n`;
                });
                message += `\n`;
            }

            const settlementPlanDiv = document.getElementById('settlement-plan');
            if (settlementPlanDiv && settlementPlanDiv.textContent !== "🎉 All debts are settled!") {
                message += `*🤝 Settlement Plan*\n`;
                const planText = settlementPlanDiv.innerText.replace(/\s+/g, ' ').trim();
                message += `${planText}\n`;
            }
            
            message += `\n_Generated by Bill Buddy_`;
            return message;
        }

        // --- Utility Functions ---
        let errorTimeout;
        function showError(message, duration = 4000, type = 'error') {
            if (!errorMsgElement) return;
            clearTimeout(errorTimeout);
            errorMsgElement.textContent = message;
            errorMsgElement.className = `p-3 rounded-lg text-sm shadow-lg transition-opacity duration-300 ${type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`;
            requestAnimationFrame(() => errorMsgElement.classList.remove('opacity-0'));
            errorTimeout = setTimeout(() => errorMsgElement.classList.add('opacity-0'), duration);
        }

        function showConfirmation(message, onConfirm) {
            confirmationMessageElement.textContent = message;
            universalConfirmationModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                universalConfirmationModal.classList.remove('opacity-0');
                universalConfirmationModal.querySelector('div').classList.remove('scale-95');
            });
            
            const cleanup = () => { 
                universalConfirmationModal.classList.add('opacity-0');
                universalConfirmationModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    universalConfirmationModal.classList.add('hidden'); 
                    confirmationConfirmBtn.onclick = null; 
                    confirmationCancelBtn.onclick = null;
                }, 300);
             };
            confirmationConfirmBtn.onclick = () => { onConfirm(); cleanup(); };
            confirmationCancelBtn.onclick = cleanup;
        }

        function showPromptModal(title, message, defaultValue = '', placeholder = 'Enter name here') {
            return new Promise(resolve => {
                modalPromptTitle.innerHTML = title;
                modalPromptMessage.textContent = message;
                modalPromptInput.value = defaultValue;
                modalPromptInput.placeholder = placeholder;
                universalPromptModal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    universalPromptModal.classList.remove('opacity-0');
                    universalPromptModal.querySelector('div').classList.remove('scale-95');
                    modalPromptInput.focus();
                    modalPromptInput.select();
                });

                const cleanup = (value) => {
                    universalPromptModal.classList.add('opacity-0');
                    universalPromptModal.querySelector('div').classList.add('scale-95');
                    setTimeout(() => {
                        universalPromptModal.classList.add('hidden');
                        modalConfirmBtn.onclick = null;
                        modalCancelBtn.onclick = null;
                        modalPromptInput.onkeydown = null;
                        resolve(value);
                    }, 300);
                };

                modalConfirmBtn.onclick = () => cleanup(modalPromptInput.value.trim());
                modalCancelBtn.onclick = () => cleanup(null);
                modalPromptInput.onkeydown = (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        cleanup(modalPromptInput.value.trim());
                    }
                };
            });
        }
        
        function safeEvaluate(expression) {
            try {
                if (!/^[0-9\s\.\+\-\*\/\(\)]+$/.test(expression)) throw new Error("Invalid characters.");
                const result = new Function('return ' + expression)();
                if (typeof result !== 'number' || !isFinite(result)) throw new Error("Invalid calculation.");
                return result;
            } catch (error) {
                showError(error.message, 3000, 'error');
                return null;
            }
        }
        
        function handleCalculatorKeydown(event) {
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const expression = calculatorInput.textContent.trim();
            if (!expression) return;
            const result = safeEvaluate(expression);
            if (result !== null) {
                const formattedResult = Number(result.toFixed(2));
                adjustmentAmountInput.value = formattedResult;
                calculatorInput.innerHTML = `${expression} = <strong class="text-indigo-600 font-bold">${formattedResult}</strong>`;
                isCalculatorResultShown = true;
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(calculatorInput);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }

        function clearForm() {
            document.getElementById('meal-type').value = '';
            document.getElementById('restaurant').value = '';
            document.getElementById('currency').value = '';
            document.getElementById('amount').value = '';
            document.querySelectorAll('#combined-buddies-payer .buddy:checked').forEach(cb => cb.checked = false);
            const payerRadio = document.querySelector('#combined-buddies-payer .payer:checked');
            if(payerRadio) payerRadio.checked = false;
            selectAllBuddiesCheckbox.checked = false;
            mealButtons.forEach(b => b.classList.remove('active'));
            currencyButtons.forEach(b => b.classList.remove('active'));
            if(calculatorInput) calculatorInput.innerHTML = '';
            isCalculatorResultShown = false;
        }

        function copyToClipboard(text, successMessage) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus(); textarea.select();
            try {
                document.execCommand('copy');
                showError(successMessage, 3000, 'success');
            } catch (err) {
                showError('Failed to copy.', 3000, 'error');
            }
            document.body.removeChild(textarea);
        }

        // --- Initial Load ---
        window.onload = () => {
            initSwipers();
            setupEventListeners();
        };

    </script>
</body>
</html>
