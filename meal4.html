<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💰 Group Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Custom scrollbar for a cleaner look - Optional */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-500 */
        }
        /* Style for active choice buttons (meal/currency) */
        .choice-btn.active {
            background-color: #0ea5e9 !important; /* sky-500 */
            color: white !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            ring-width: 2px;
            --tw-ring-color: #7dd3fc; /* sky-300 */
        }
        /* Custom checkbox style if not using @tailwindcss/forms */
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem; /* h-5 */
            width: 1.25rem; /* w-5 */
            border: 1px solid #94a3b8; /* slate-400 */
            border-radius: 0.25rem; /* rounded */
            display: inline-block;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .custom-checkbox:checked {
            background-color: #0ea5e9; /* sky-500 */
            border-color: #0ea5e9; /* sky-500 */
        }
        .custom-checkbox:checked::after {
            content: '✔';
            font-size: 0.8rem;
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .custom-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5); /* focus:ring-sky-500 with opacity */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-sky-100 min-h-screen flex flex-col pt-16 pb-20">

    <header class="text-center py-3 px-4 bg-gradient-to-r from-sky-500 to-indigo-600 shadow-lg fixed top-0 left-0 right-0 z-40 h-16 flex items-center justify-center">
        <h1 class="text-xl md:text-2xl font-bold text-white drop-shadow-sm">💰 Group Expense Tracker</h1>
    </header>

    <main class="flex-grow overflow-y-auto w-full">
        <section id="page-participants" class="page p-4 md:p-6">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-2xl mx-auto">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-700 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">👥</span>Manage Participants
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="group-event-name" class="block text-sm font-semibold text-slate-600 mb-1.5">Group Event Name</label>
                        <input type="text" id="group-event-name" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="e.g., Weekend Getaway 🎉" required>
                    </div>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="new-participant" class="flex-grow p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="Enter participant name">
                        <button id="add-participant" class="bg-sky-500 text-white font-medium py-2.5 px-4 rounded-lg shadow hover:bg-sky-600 active:bg-sky-700 transform active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-1.5 shrink-0">
                            <span class="text-lg">✨</span>Add
                        </button>
                    </div>
                    <div id="participant-list" class="flex flex-col gap-3"></div>
                    <button id="done-participants" class="w-full bg-emerald-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-600 active:bg-emerald-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2">
                        <span class="text-lg">✅</span>Done & Proceed
                    </button>
                </div>
            </div>
        </section>

        <section id="page-expense" class="page p-4 md:p-6 hidden">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-2xl mx-auto">
                <h2 id="expense-form-title" class="text-xl sm:text-2xl font-bold text-slate-700 flex items-center gap-2">
                     <span class="text-2xl sm:text-3xl">💸</span>Add New Expense
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Meal Type</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-meal="Breakfast"><span class="text-lg">🥞</span>Breakfast</button>
                            <button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-meal="Lunch"><span class="text-lg">🥪</span>Lunch</button>
                            <button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-meal="Tea"><span class="text-lg">🍵</span>Tea/Snacks</button>
                            <button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-meal="Dinner"><span class="text-lg">🍝</span>Dinner</button>
                            <button type="button" class="meal-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-meal="Other"><span class="text-lg">🛍️</span>Other</button>
                        </div>
                        <input type="hidden" id="meal-type" name="meal-type">
                    </div>

                    <div>
                        <label for="restaurant" class="block text-sm font-semibold text-slate-600 mb-1.5">Place / Item Name</label>
                        <input type="text" id="restaurant" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="e.g., Cafe Delight or Movie Tickets" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Currency</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-currency="HKD"><span class="text-lg">🇭🇰</span>HKD</button>
                            <button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-currency="CNY"><span class="text-lg">🇨🇳</span>CNY</button>
                            <button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-currency="JPY"><span class="text-lg">🇯🇵</span>JPY</button>
                            <button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-currency="USD"><span class="text-lg">🇺🇸</span>USD</button>
                            <button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-currency="EUR"><span class="text-lg">🇪🇺</span>EUR</button>
                            <button type="button" class="currency-btn choice-btn bg-slate-100 text-slate-700 px-3 py-2 rounded-lg hover:bg-sky-100 transition-all duration-150 ease-in-out text-sm font-medium flex items-center gap-1.5 justify-center" data-currency="GBP"><span class="text-lg">🇬🇧</span>GBP</button>
                        </div>
                        <input type="hidden" id="currency" name="currency">
                    </div>

                    <div>
                        <label for="amount" class="block text-sm font-semibold text-slate-600 mb-1.5">Total Amount</label>
                        <input type="number" id="amount" class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow placeholder-slate-400" placeholder="Enter amount" min="0" step="0.01" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Who participated?</label>
                        <div id="expense-participants" class="space-y-2"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-600 mb-1.5">Who paid?</label>
                        <div id="expense-payer" class="space-y-2"></div>
                    </div>

                    <button id="add-expense" class="w-full bg-sky-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-sky-600 active:bg-sky-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2">
                        <span class="text-lg">🎉</span>Add Expense
                    </button>
                </div>
            </div>
        </section>

        <section id="page-summary" class="page p-4 md:p-6 hidden">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-4xl mx-auto">
                 <h2 class="text-xl sm:text-2xl font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">📊</span>Expense Summary (HKD)
                </h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-slate-200">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Person</th>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Total Owed</th>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>

                <h2 class="text-xl sm:text-2xl font-bold text-slate-700 mt-6 mb-3 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">🧾</span>Meal Records
                </h2>
                <p id="total-spent" class="text-md font-semibold text-slate-700 mb-2"></p>
                <div id="meal-records" class="space-y-3"></div>
            </div>
        </section>

        <section id="page-debt" class="page p-4 md:p-6 hidden">
            <div class="bg-white rounded-xl shadow-xl p-5 sm:p-6 space-y-6 max-w-4xl mx-auto">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <span class="text-2xl sm:text-3xl">🤝</span>Debt Settlement
                </h2>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-slate-200">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Person</th>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Paid</th>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Owed</th>
                                <th class="py-3 px-4 text-slate-600 font-semibold uppercase text-xs tracking-wider">Net Balance</th>
                            </tr>
                        </thead>
                        <tbody id="debt-table" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                <div id="settlement-plan-container" class="mt-4">
                     <h3 class="text-md font-semibold text-slate-600 mb-2">Settlement Plan:</h3>
                     <div id="settlement-plan" class="text-sm space-y-1"></div>
                </div>
                <button id="reset" class="w-full bg-rose-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-rose-600 active:bg-rose-700 transform hover:scale-105 active:scale-95 transition-all duration-150 ease-in-out flex items-center justify-center gap-2 mt-4">
                    <span class="text-lg">♻️</span>Reset All Data
                </button>
            </div>
        </section>
    </main>

    <div id="error-container" class="fixed top-20 left-1/2 -translate-x-1/2 transform z-[100] w-auto max-w-[90%] pointer-events-none">
         <p id="error" class="bg-red-100 text-red-700 border border-red-300 p-3 rounded-lg text-sm shadow-lg opacity-0 transition-opacity duration-300"></p>
    </div>


    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md shadow-[0_-4px_10px_rgba(0,0,0,0.05)] flex justify-around items-stretch h-20 z-40 border-t border-slate-200/80">
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-participants">
            <span class="text-2xl">👥</span>
            <span class="text-xs mt-1">Participants</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-expense">
            <span class="text-2xl">💸</span>
            <span class="text-xs mt-1">Expense</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-summary">
            <span class="text-2xl">📊</span>
            <span class="text-xs mt-1">Summary</span>
        </button>
        <button class="nav-btn flex-1 flex flex-col items-center justify-center text-slate-600 hover:text-sky-500 transition-colors py-2 focus:outline-none" data-page="page-debt">
            <span class="text-2xl">🤝</span>
            <span class="text-xs mt-1">Debt</span>
        </button>
    </nav>

    <script>
        // API key for ExchangeRate-API (replace with your own key from https://www.exchangerate-api.com/)
        const API_KEY = 'YOUR_API_KEY_HERE'; // Sign up for a free key

        // Fallback exchange rates to HKD
        const fallbackRates = { HKD: 1, CNY: 1.1, JPY: 0.055, USD: 7.8, EUR: 8.5, GBP: 10.0 };
        let exchangeRates = { ...fallbackRates };

        let participants = JSON.parse(localStorage.getItem('participants')) || ['Alice Sparkle', 'Bob Nova', 'Charlie Beam', 'Diana Glimmer'];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let groupEventName = localStorage.getItem('groupEventName') || '';

        async function fetchExchangeRates() {
            if (API_KEY === 'YOUR_API_KEY_HERE') {
                console.warn('Using fallback exchange rates. Please provide an API key for live rates.');
                showError('Using fallback exchange rates. Get a free API key for live data.', 5000);
                // No need to proceed with fetch if API key is not set
                updateSummary();
                updateMealRecords();
                updateDebtSettlement();
                return;
            }
            try {
                const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/HKD`);
                if (!response.ok) throw new Error(`API request failed: ${response.status}`);
                const data = await response.json();
                if (data.result === 'success' && data.conversion_rates) {
                    // Ensure all expected currencies are present in the API response
                    const requiredCurrencies = ['CNY', 'JPY', 'USD', 'EUR', 'GBP'];
                    const apiRates = data.conversion_rates;
                    let ratesComplete = true;
                    requiredCurrencies.forEach(curr => {
                        if (!apiRates[curr]) {
                            ratesComplete = false;
                            console.warn(`Currency ${curr} not found in API response. Using fallback for ${curr}.`);
                        }
                    });

                    if (ratesComplete) {
                         exchangeRates = {
                            HKD: 1,
                            CNY: apiRates.HKD / apiRates.CNY, // Example: if base is USD, 1 USD = X HKD, 1 USD = Y CNY. So 1 CNY = (X/Y) HKD
                            JPY: apiRates.HKD / apiRates.JPY,
                            USD: apiRates.HKD / apiRates.USD,
                            EUR: apiRates.HKD / apiRates.EUR,
                            GBP: apiRates.HKD / apiRates.GBP
                        };
                        // More direct way if API base is HKD:
                        // exchangeRates = {
                        //     HKD: 1,
                        //     CNY: 1 / data.conversion_rates.CNY, // If API gives HKD per OtherCurrency
                        //     JPY: 1 / data.conversion_rates.JPY,
                        //     USD: 1 / data.conversion_rates.USD,
                        //     EUR: 1 / data.conversion_rates.EUR,
                        //     GBP: 1 / data.conversion_rates.GBP
                        // };
                        // The provided API (v6.exchangerate-api.com/v6/API_KEY/latest/HKD) gives rates relative to HKD.
                        // So, 1 HKD = X CNY, 1 HKD = Y JPY etc.
                        // We need AmountInOtherCurrency * RateToGetHKD = AmountInHKD
                        // So if we have 100 JPY, and 1 HKD = 15 JPY, then 1 JPY = 1/15 HKD. So 100 JPY = 100 * (1/15) HKD.
                        // The API gives: "HKD": {"CNY": 0.88, "JPY": 0.05} means 1 HKD = 0.88 CNY, 1 HKD = 0.05 JPY.
                        // This is not what we want. We want 1 CNY = X HKD.
                        // The API response structure for base HKD is: "conversion_rates": {"HKD":1, "USD":0.128, "CNY":0.9,...}
                        // This means 1 HKD = 0.128 USD. So 1 USD = 1/0.128 HKD.
                        // And 1 HKD = 0.9 CNY. So 1 CNY = 1/0.9 HKD.
                        // So, if amount is in CNY, amountHKD = amountCNY * (1 / data.conversion_rates.CNY)
                        // This seems correct for the original structure. Let's verify the fallback rates logic.
                        // fallbackRates = { CNY: 1.1 } means 1 CNY = 1.1 HKD.
                        // So, `amount * exchangeRates[currency]` where `exchangeRates[CNY]` should be `1 / data.conversion_rates.CNY`.
                        // Let's re-verify the API response. If base is HKD, `data.conversion_rates.USD` is how many USD 1 HKD is.
                        // So, to convert USD to HKD: `amountUSD / data.conversion_rates.USD`.
                        // This means `exchangeRates.USD` should be `1 / data.conversion_rates.USD`.
                        // The original code had this:
                        // CNY: 1 / data.conversion_rates.CNY,
                        // This means exchangeRates.CNY is the factor to multiply CNY amount by to get HKD.
                        // This is correct.
                         exchangeRates = {
                            HKD: 1,
                            CNY: (apiRates.CNY ? 1 / apiRates.CNY : fallbackRates.CNY),
                            JPY: (apiRates.JPY ? 1 / apiRates.JPY : fallbackRates.JPY),
                            USD: (apiRates.USD ? 1 / apiRates.USD : fallbackRates.USD),
                            EUR: (apiRates.EUR ? 1 / apiRates.EUR : fallbackRates.EUR),
                            GBP: (apiRates.GBP ? 1 / apiRates.GBP : fallbackRates.GBP)
                        };

                    } else {
                         throw new Error('API response missing some currency rates.');
                    }
                } else {
                     throw new Error(data['error-type'] || 'API request was not successful');
                }
            } catch (error) {
                console.error('Failed to fetch exchange rates:', error);
                showError(`API Error: ${error.message}. Using fallback rates.`, 5000);
                exchangeRates = { ...fallbackRates }; // Ensure fallback on error
            }
            updateSummary();
            updateMealRecords();
            updateDebtSettlement();
        }


        function formatTimestamp(dateString) {
            const date = new Date(dateString);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            return `${dayName}, ${day} ${month} ${year}, ${hours}:${minutes}${ampm}`;
        }

        const mealButtons = document.querySelectorAll('.meal-btn');
        const currencyButtons = document.querySelectorAll('.currency-btn');
        const addExpenseBtn = document.getElementById('add-expense');
        const resetBtn = document.getElementById('reset');
        const addParticipantBtn = document.getElementById('add-participant');
        const newParticipantInput = document.getElementById('new-participant');
        const doneParticipantsBtn = document.getElementById('done-participants');
        const groupEventNameInput = document.getElementById('group-event-name');
        const expenseFormTitle = document.getElementById('expense-form-title');
        const errorMsgElement = document.getElementById('error');
        const navButtons = document.querySelectorAll('.nav-btn');

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            navButtons.forEach(btn => {
                const isActive = btn.dataset.page === pageId;
                btn.classList.toggle('text-sky-600', isActive);
                btn.classList.toggle('font-semibold', isActive);
                btn.classList.toggle('bg-sky-100', isActive);
                btn.classList.toggle('rounded-lg', isActive); // Add rounded on active for better visual cue
                btn.classList.toggle('text-slate-600', !isActive);
                if (!isActive) {
                    btn.classList.remove('bg-sky-100', 'rounded-lg');
                }
            });
             window.scrollTo(0, 0); // Scroll to top on page change
        }

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => showPage(btn.dataset.page));
        });

        if (participants.length === 0 || !groupEventName) {
            showPage('page-participants');
        } else {
            showPage('page-expense');
        }

        groupEventNameInput.value = groupEventName;
        updateFormTitle();

        function updateFormTitle() {
            const titleBase = groupEventName ? `for ${groupEventName}` : '';
            expenseFormTitle.innerHTML = `<span class="text-2xl sm:text-3xl">💸</span>Add New Expense ${titleBase}`;
        }

        mealButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                mealButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('meal-type').value = btn.dataset.meal;
            });
        });

        currencyButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                currencyButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('currency').value = btn.dataset.currency;
            });
        });

        function updateParticipantList() {
            const participantList = document.getElementById('participant-list');
            const expenseParticipantsContainer = document.getElementById('expense-participants');
            const expensePayerContainer = document.getElementById('expense-payer');

            if(!participantList || !expenseParticipantsContainer || !expensePayerContainer) return;

            participantList.innerHTML = '';
            expenseParticipantsContainer.innerHTML = '';
            expensePayerContainer.innerHTML = '';

            participants.forEach((person, index) => {
                const personId = `person_${index}_${person.replace(/\s+/g, '_')}`; // Create a more robust ID

                // Manage Participants section
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center justify-between bg-slate-50 p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow';
                listItem.innerHTML = `
                    <span class="text-slate-800 font-medium text-sm sm:text-base">${person}</span>
                    <div class="flex gap-2">
                        <button class="edit-participant bg-amber-400 text-white p-0 rounded-md hover:bg-amber-500 transition-colors text-lg flex items-center justify-center w-9 h-9" data-index="${index}" aria-label="Edit ${person}">✏️</button>
                        <button class="delete-participant bg-rose-500 text-white p-0 rounded-md hover:bg-rose-600 transition-colors text-lg flex items-center justify-center w-9 h-9" data-index="${index}" aria-label="Delete ${person}">🗑️</button>
                    </div>
                `;
                participantList.appendChild(listItem);

                // Expense Participants checkboxes
                const participantLabel = document.createElement('label');
                participantLabel.className = 'flex items-center gap-3 p-2.5 hover:bg-slate-50 rounded-md cursor-pointer transition-colors';
                participantLabel.innerHTML = `
                    <input type="checkbox" class="participant custom-checkbox" value="${person}" id="exp_part_${personId}">
                    <span class="text-sm text-slate-700">${person}</span>`;
                expenseParticipantsContainer.appendChild(participantLabel);

                // Payer radio buttons (better for single selection)
                const payerLabel = document.createElement('label');
                payerLabel.className = 'flex items-center gap-3 p-2.5 hover:bg-slate-50 rounded-md cursor-pointer transition-colors';
                payerLabel.innerHTML = `
                    <input type="radio" name="payer" class="payer custom-checkbox" value="${person}" id="payer_${personId}">
                     <span class="text-sm text-slate-700">${person}</span>`;
                expensePayerContainer.appendChild(payerLabel);
            });


            document.querySelectorAll('.edit-participant').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    const currentName = participants[index];
                    const newName = prompt(`Enter new name for ${currentName}`, currentName);
                    if (newName && newName.trim() && newName.trim() !== currentName) {
                        if (participants.includes(newName.trim())) {
                            showError('Participant name already exists.');
                            return;
                        }
                        if (newName.trim().length > 50) {
                            showError('Participant name must be 50 characters or less.');
                            return;
                        }
                        const oldName = participants[index];
                        participants[index] = newName.trim();
                        expenses.forEach(exp => {
                            exp.participants = exp.participants.map(p => p === oldName ? newName.trim() : p);
                            if (exp.payer === oldName) exp.payer = newName.trim();
                        });
                        localStorage.setItem('participants', JSON.stringify(participants));
                        localStorage.setItem('expenses', JSON.stringify(expenses));
                        updateParticipantList();
                        updateSummary();
                        updateMealRecords();
                        updateDebtSettlement();
                         showError(`'${oldName}' renamed to '${newName.trim()}'`, 3000, 'success');
                    }
                });
            });

            document.querySelectorAll('.delete-participant').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    const personToDelete = participants[index];
                    if (expenses.some(exp => exp.participants.includes(personToDelete) || exp.payer === personToDelete)) {
                        showError(`Cannot delete ${personToDelete}. They are part of existing expenses or paid for an item. Please resolve expenses first.`, 5000);
                        return;
                    }
                    if (confirm(`Are you sure you want to delete ${personToDelete}? This action cannot be undone.`)) {
                        participants.splice(index, 1);
                        localStorage.setItem('participants', JSON.stringify(participants));
                        updateParticipantList();
                        updateSummary();
                        updateMealRecords();
                        updateDebtSettlement();
                        showError(`${personToDelete} has been deleted.`, 3000, 'success');
                    }
                });
            });
        }

        addParticipantBtn.addEventListener('click', () => {
            const newName = newParticipantInput.value.trim();
            if (!newName) {
                showError('Please enter a participant name.');
                return;
            }
            if (participants.includes(newName)) {
                showError('Participant already exists.');
                return;
            }
            if (newName.length > 50) {
                showError('Participant name must be 50 characters or less.');
                return;
            }
            participants.push(newName);
            localStorage.setItem('participants', JSON.stringify(participants));
            newParticipantInput.value = '';
            updateParticipantList();
            updateSummary();
            updateMealRecords();
            updateDebtSettlement();
            showError(`${newName} added successfully! ✨`, 3000, 'success');
        });

        doneParticipantsBtn.addEventListener('click', () => {
            const eventName = groupEventNameInput.value.trim();
            if (!eventName) {
                showError('Please enter a group event name.');
                return;
            }
            if (participants.length === 0) {
                showError('Please add at least one participant.');
                return;
            }
            groupEventName = eventName;
            localStorage.setItem('groupEventName', groupEventName);
            updateFormTitle();
            showPage('page-expense');
        });

        addExpenseBtn.addEventListener('click', () => {
            if (!groupEventName) {
                showError('Please set a group event name in Participants tab first.');
                showPage('page-participants');
                return;
            }
            const mealType = document.getElementById('meal-type').value;
            const restaurant = document.getElementById('restaurant').value.trim();
            const currency = document.getElementById('currency').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const selectedParticipants = Array.from(document.querySelectorAll('.participant:checked')).map(cb => cb.value);
            const selectedPayerRadio = document.querySelector('.payer:checked');
            const selectedPayer = selectedPayerRadio ? selectedPayerRadio.value : null;


            if (!mealType) { showError('Please select a meal type.'); return; }
            if (!restaurant) { showError('Please enter a place or item name.'); return; }
            if (!currency) { showError('Please select a currency.'); return; }
            if (isNaN(amount) || amount <= 0) { showError('Please enter a valid amount.'); return; }
            if (selectedParticipants.length === 0) { showError('Please select at least one participant.'); return; }
            if (!selectedPayer) { showError('Please select who paid.'); return; }
            if (!selectedParticipants.includes(selectedPayer)) {
                showError('The payer must be one of the selected participants.');
                return;
            }

            const amountHKD = amount * (exchangeRates[currency] || 1); // Default to 1 if rate undefined
            const perPerson = amountHKD / selectedParticipants.length;

            const expense = {
                mealType, restaurant, eventName: groupEventName, currency, amount, amountHKD,
                participants: selectedParticipants, perPerson, payer: selectedPayer,
                timestamp: new Date().toISOString()
            };
            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            updateSummary();
            updateMealRecords();
            updateDebtSettlement();
            clearForm();
            showError('Expense added successfully! 🎉', 3000, 'success');
            showPage('page-summary'); // Go to summary after adding
        });

        resetBtn.addEventListener('click', () => {
            if (!confirm('Are you sure you want to reset ALL data? This includes participants, event name, and all expenses. This action cannot be undone.')) {
                return;
            }
            expenses = [];
            participants = ['Alice Sparkle', 'Bob Nova', 'Charlie Beam', 'Diana Glimmer']; // Reset to new defaults
            groupEventName = '';
            localStorage.setItem('participants', JSON.stringify(participants));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.removeItem('groupEventName');
            groupEventNameInput.value = '';
            updateFormTitle();
            updateParticipantList();
            updateSummary();
            updateMealRecords();
            updateDebtSettlement();
            clearForm();
            showError('All data has been reset. Ready for a fresh start! 🚀', 3000, 'success');
            showPage('page-participants');
        });

        let errorTimeout;
        function showError(message, duration = 3000, type = 'error') {
            if (!errorMsgElement) return;
            clearTimeout(errorTimeout);
            errorMsgElement.textContent = message;
            errorMsgElement.classList.remove('opacity-0');

            // Apply styles based on type
            errorMsgElement.classList.remove('bg-red-100', 'text-red-700', 'border-red-300', 'bg-green-100', 'text-green-700', 'border-green-300');
            if (type === 'success') {
                errorMsgElement.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
            } else { // Default to error
                errorMsgElement.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
            }

            errorTimeout = setTimeout(() => {
                errorMsgElement.classList.add('opacity-0');
            }, duration);
        }


        function clearForm() {
            document.getElementById('meal-type').value = '';
            document.getElementById('restaurant').value = '';
            document.getElementById('currency').value = '';
            document.getElementById('amount').value = '';
            document.querySelectorAll('.participant:checked').forEach(cb => cb.checked = false);
            const payerRadio = document.querySelector('.payer:checked');
            if(payerRadio) payerRadio.checked = false;

            mealButtons.forEach(b => b.classList.remove('active'));
            currencyButtons.forEach(b => b.classList.remove('active'));
        }

        function updateSummary() {
            const summaryTableBody = document.getElementById('summary-table');
            if(!summaryTableBody) return;
            summaryTableBody.innerHTML = '';
            const totals = {};
            const details = {};

            participants.forEach(person => {
                totals[person] = 0;
                details[person] = [];
            });

            expenses.forEach(exp => {
                exp.participants.forEach(person => {
                    const perPersonHKD = exp.perPerson;
                    totals[person] += perPersonHKD;
                    details[person].push(`<div class="text-xs"><span class="font-medium">${exp.mealType}</span> at ${exp.restaurant}: ${perPersonHKD.toFixed(2)} HKD</div>`);
                });
            });

            if (participants.length === 0) {
                const row = summaryTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 3;
                cell.className = 'py-4 px-4 text-center text-slate-500';
                cell.textContent = 'No participants added yet.';
                return;
            }


            participants.forEach(person => {
                const row = summaryTableBody.insertRow();
                row.innerHTML = `
                    <td class="py-3 px-4 border-b border-slate-200 text-slate-700 font-medium">${person}</td>
                    <td class="py-3 px-4 border-b border-slate-200 text-slate-700">${totals[person].toFixed(2)} HKD</td>
                    <td class="py-3 px-4 border-b border-slate-200 text-slate-700 space-y-1">${details[person].join('') || '<span class="text-slate-400">No expenses</span>'}</td>
                `;
            });
        }

        function updateMealRecords() {
            const totalSpentElement = document.getElementById('total-spent');
            const mealRecordsContainer = document.getElementById('meal-records');
            if(!totalSpentElement || !mealRecordsContainer) return;

            mealRecordsContainer.innerHTML = '';
            const total = expenses.reduce((sum, exp) => sum + exp.amountHKD, 0);
            const count = expenses.length;
            totalSpentElement.textContent = `Total Spent: HK$${total.toFixed(2)} | ${count} transaction${count !== 1 ? 's' : ''}`;

            if (expenses.length === 0) {
                mealRecordsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No meal records yet. Add an expense! 🍽️</p>';
                return;
            }
            // Sort expenses by timestamp, newest first
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedExpenses.forEach(exp => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3.5 rounded-lg shadow-sm border border-slate-200 text-xs text-slate-600 leading-relaxed hover:shadow-md transition-shadow';
                const timestamp = formatTimestamp(exp.timestamp);
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold text-slate-800 text-sm">${exp.mealType} @ ${exp.restaurant}</span>
                        <span class="text-sky-600 font-bold text-sm">${exp.currency} ${exp.amount.toFixed(2)}</span>
                    </div>
                    <div class="text-xs">Paid by: <strong class="text-slate-700">${exp.payer}</strong></div>
                    <div class="text-xs">Shared with: <em class="text-slate-500">${exp.participants.join(', ')}</em></div>
                    <div class="text-right text-slate-400 text-[10px] mt-1.5">${timestamp}</div>
                `;
                mealRecordsContainer.appendChild(div);
            });
        }

        function updateDebtSettlement() {
            const debtTableBody = document.getElementById('debt-table');
            const settlementPlanDiv = document.getElementById('settlement-plan');
            if(!debtTableBody || !settlementPlanDiv) return;

            debtTableBody.innerHTML = '';
            settlementPlanDiv.innerHTML = '';

            const balances = {};
            participants.forEach(person => {
                balances[person] = { paid: 0, owed: 0, net: 0 };
            });

            expenses.forEach(exp => {
                balances[exp.payer].paid += exp.amountHKD;
                exp.participants.forEach(person => {
                    balances[person].owed += exp.perPerson;
                });
            });

            participants.forEach(person => {
                balances[person].net = balances[person].paid - balances[person].owed;
            });

            if (participants.length === 0) {
                const row = debtTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 4;
                cell.className = 'py-4 px-4 text-center text-slate-500';
                cell.textContent = 'No participants added yet.';
                settlementPlanDiv.innerHTML = '<p class="text-slate-500 text-center py-2">Add participants and expenses to see settlements.</p>';
                return;
            }


            participants.forEach(person => {
                const net = balances[person].net;
                const colorClass = net < -0.005 ? 'text-red-600 font-semibold' : net > 0.005 ? 'text-green-600 font-semibold' : 'text-slate-700';
                const row = debtTableBody.insertRow();
                row.innerHTML = `
                    <td class="py-3 px-4 border-b border-slate-200 text-slate-700 font-medium">${person}</td>
                    <td class="py-3 px-4 border-b border-slate-200 text-slate-700">${balances[person].paid.toFixed(2)} HKD</td>
                    <td class="py-3 px-4 border-b border-slate-200 text-slate-700">${balances[person].owed.toFixed(2)} HKD</td>
                    <td class="py-3 px-4 border-b border-slate-200 ${colorClass}">${net.toFixed(2)} HKD</td>
                `;
            });

            const debtors = participants.filter(p => balances[p].net < -0.005).map(p => ({ name: p, amount: -balances[p].net }));
            const creditors = participants.filter(p => balances[p].net > 0.005).map(p => ({ name: p, amount: balances[p].net }));
            const settlements = [];

            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const amountToSettle = Math.min(debtors[i].amount, creditors[j].amount);
                if (amountToSettle > 0.005) { // Only settle if amount is significant
                    settlements.push(`<span class="font-medium text-rose-600">${debtors[i].name}</span> pays <span class="font-medium text-emerald-600">${creditors[j].name}</span> <strong class="text-sky-700">${amountToSettle.toFixed(2)} HKD</strong>`);
                    debtors[i].amount -= amountToSettle;
                    creditors[j].amount -= amountToSettle;
                }
                if (debtors[i].amount < 0.005) i++;
                if (creditors[j].amount < 0.005) j++;
            }

            if (settlements.length === 0) {
                settlementPlanDiv.innerHTML = '<p class="text-green-600 font-medium text-center py-2">🎉 All debts are settled (or no debts to settle)!</p>';
            } else {
                const ul = document.createElement('ul');
                ul.className = 'space-y-2';
                settlements.forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'bg-sky-50 p-2.5 rounded-md text-sm shadow-sm border border-sky-100';
                    li.innerHTML = s;
                    ul.appendChild(li);
                });
                settlementPlanDiv.appendChild(ul);
            }
        }

        // Initialize on load
        fetchExchangeRates(); // This will call updates after fetching
        updateParticipantList(); // Initial call for UI setup
        // Other updates are called within fetchExchangeRates or after data changes
    </script>
</body>
</html>
